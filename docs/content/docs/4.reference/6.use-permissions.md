---
title: Permissions
description: Permission composables and helpers.
navigation:
  icon: i-lucide-shield
---

Create type-safe permission checks for your application using `createPermissions`.

## Enable Permissions

First, enable permissions in your config:

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  convex: {
    permissions: true,
  },
})
```

## createPermissions

Factory function to create permission composables for your app.

### Signature

```ts
function createPermissions<Permission extends string>(config: {
  query: FunctionReference<'query'>
  checkPermission: (ctx: Context | null, permission: Permission, resource?: Resource) => boolean
}): {
  usePermissions: () => UsePermissionsReturn<Permission>
  usePermissionGuard: (options: GuardOptions) => void
}
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `query` | `FunctionReference<'query'>` | Convex query returning permission context |
| `checkPermission` | `(ctx, permission, resource?) => boolean` | Permission check function |

### Example Setup

```ts [composables/usePermissions.ts]
import { createPermissions } from '#imports'
import { api } from '~/convex/_generated/api'
import { checkPermission, type Permission } from '~/convex/permissions.config'

export const { usePermissions, usePermissionGuard } = createPermissions<Permission>({
  query: api.auth.getPermissionContext,
  checkPermission: (ctx, permission, resource) => {
    if (!ctx) return false
    return checkPermission(ctx.role, ctx.userId, permission, resource?.ownerId)
  },
})
```

## usePermissions

Access permission state and check permissions.

### Return Value

| Property | Type | Description |
|----------|------|-------------|
| `can` | `(permission, resource?) => ComputedRef<boolean>` | Check a permission |
| `role` | `ComputedRef<string \| null>` | Current user's role |
| `user` | `Ref<PermissionContext \| null>` | Full permission context |
| `isAuthenticated` | `ComputedRef<boolean>` | True if context loaded |
| `isPending` | `ComputedRef<boolean>` | True while loading |

### Usage

```vue
<script setup lang="ts">
import { usePermissions } from '~/composables/usePermissions'

const { can, role, isAuthenticated } = usePermissions()
</script>

<template>
  <div>
    <p>Role: {{ role }}</p>

    <!-- Simple permission -->
    <button v-if="can('settings.view')">Settings</button>

    <!-- Permission with resource (ownership check) -->
    <button v-if="can('post.edit', post)">Edit</button>
  </div>
</template>
```

### can()

The `can` function returns a `ComputedRef<boolean>` that:

- Is reactive (updates when role changes)
- Auto-unwraps in templates
- Accepts an optional resource for ownership checks

```ts
// Simple permission
const canInvite = can('members.invite')
// canInvite.value is boolean

// Ownership permission
const canEdit = can('post.update', { ownerId: post.ownerId })
```

## usePermissionGuard

Redirect users who lack a permission.

### Signature

```ts
function usePermissionGuard(options: {
  permission: Permission
  redirectTo?: string
  resource?: Resource
  loginPath?: string
}): void
```

### Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `permission` | `Permission` | required | Permission to check |
| `redirectTo` | `string` | `'/'` | Where to redirect if denied |
| `resource` | `Resource` | `undefined` | Resource for ownership checks |
| `loginPath` | `string` | `'/login'` | Redirect for unauthenticated users |

### Usage

```vue [app/pages/settings.vue]
<script setup lang="ts">
import { usePermissionGuard } from '~/composables/usePermissions'

// Redirect to /dashboard if user can't view settings
usePermissionGuard({
  permission: 'settings.view',
  redirectTo: '/dashboard',
})
</script>

<template>
  <h1>Settings</h1>
</template>
```

## Permission Configuration

Define your permissions in a shared config file:

```ts [convex/permissions.config.ts]
export const ROLES = ['owner', 'admin', 'member', 'viewer'] as const
export type Role = (typeof ROLES)[number]

export const permissions = {
  // Simple: role list
  'settings.view': { roles: ['owner'] },
  'members.invite': { roles: ['owner', 'admin'] },

  // Ownership: own vs any
  'post.update': { own: ['member'], any: ['owner', 'admin'] },
  'post.delete': { own: ['member'], any: ['owner', 'admin'] },
} as const

export type Permission = keyof typeof permissions

export function checkPermission(
  role: Role | null,
  userId: string | null,
  permission: Permission,
  resourceOwnerId?: string,
): boolean {
  if (!role) return false

  const rule = permissions[permission]

  // Simple permission
  if ('roles' in rule) {
    return rule.roles.includes(role)
  }

  // Ownership permission
  if ('any' in rule && rule.any.includes(role)) {
    return true
  }

  if ('own' in rule && rule.own.includes(role)) {
    return resourceOwnerId === userId
  }

  return false
}
```

## Backend Query

Your permission context query:

```ts [convex/auth.ts]
export const getPermissionContext = query({
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity()
    if (!identity) return null

    const user = await ctx.db
      .query('users')
      .withIndex('by_auth_id', q => q.eq('authId', identity.subject))
      .first()

    if (!user) return null

    return {
      role: user.role,
      userId: user.authId,
      // Add any other context your app needs
    }
  },
})
```

## Extended Composable

Add app-specific helpers:

```ts [composables/usePermissions.ts]
import { computed } from 'vue'
import { createPermissions } from '#imports'
import { api } from '~/convex/_generated/api'
import { checkPermission, type Permission } from '~/convex/permissions.config'

const { usePermissions: useBase, usePermissionGuard } = createPermissions<Permission>({
  query: api.auth.getPermissionContext,
  checkPermission,
})

export function usePermissions() {
  const base = useBase()

  // Add role helpers
  const isOwner = computed(() => base.role.value === 'owner')
  const isAdmin = computed(() => base.role.value === 'admin')
  const canManageMembers = computed(() =>
    base.role.value === 'owner' || base.role.value === 'admin'
  )

  return {
    ...base,
    isOwner,
    isAdmin,
    canManageMembers,
  }
}

export { usePermissionGuard }
```

## Security Note

Frontend permission checks are for UX only. Always enforce on the backend:

```ts [convex/posts.ts]
import { authorize } from './lib/permissions'

export const update = mutation({
  args: { id: v.id('posts'), title: v.string() },
  handler: async (ctx, args) => {
    const post = await ctx.db.get(args.id)
    if (!post) throw new Error('Not found')

    // This is where security actually happens
    await authorize(ctx, 'post.update', post)

    await ctx.db.patch(args.id, { title: args.title })
  },
})
```

## TypeScript

Permissions are fully typed:

```ts
// Permission type is inferred from your config
can('settings.view')  // ✓
can('invalid.perm')   // ✗ Type error

// Resource type for ownership checks
can('post.update', { ownerId: '123' })  // ✓
```
