---
title: Server Utils
description: Execute Convex operations from Nuxt server routes.
navigation:
  icon: i-lucide-terminal
---

Execute queries, mutations, and actions from Nuxt server routes and API endpoints. These utilities are auto-imported in the server context.

## fetchQuery

Execute a Convex query from server-side code.

### Signature

```ts
function fetchQuery<Query>(
  query: Query,
  args?: FunctionArgs<Query>,
  options?: { token?: string }
): Promise<FunctionReturnType<Query>>
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `query` | `FunctionReference<'query'>` | The query to execute |
| `args` | `object` | Arguments for the query |
| `options.token` | `string` | Optional auth token |

### Example

```ts [server/api/posts/[id].ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const id = getRouterParam(event, 'id')

  const post = await fetchQuery(api.posts.get, { id })

  if (!post) {
    throw createError({ statusCode: 404, message: 'Post not found' })
  }

  return post
})
```

### With Authentication

```ts [server/api/user/profile.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  // Get token from request header or cookie
  const token = getHeader(event, 'Authorization')?.replace('Bearer ', '')

  const profile = await fetchQuery(
    api.user.profile,
    {},
    { token }
  )

  return profile
})
```

## fetchMutation

Execute a Convex mutation from server-side code.

### Signature

```ts
function fetchMutation<Mutation>(
  mutation: Mutation,
  args?: FunctionArgs<Mutation>,
  options?: { token?: string }
): Promise<FunctionReturnType<Mutation>>
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `mutation` | `FunctionReference<'mutation'>` | The mutation to execute |
| `args` | `object` | Arguments for the mutation |
| `options.token` | `string` | Optional auth token |

### Example

```ts [server/api/posts/create.post.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const body = await readBody(event)
  const token = getHeader(event, 'Authorization')?.replace('Bearer ', '')

  const postId = await fetchMutation(
    api.posts.create,
    {
      title: body.title,
      content: body.content,
    },
    { token }
  )

  return { id: postId }
})
```

### Webhook Handler

```ts [server/api/webhooks/stripe.post.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const body = await readBody(event)

  // Verify webhook signature...

  if (body.type === 'payment.succeeded') {
    await fetchMutation(api.orders.markPaid, {
      orderId: body.data.orderId,
      paymentId: body.data.paymentId,
    })
  }

  return { received: true }
})
```

## fetchAction

Execute a Convex action from server-side code.

### Signature

```ts
function fetchAction<Action>(
  action: Action,
  args?: FunctionArgs<Action>,
  options?: { token?: string }
): Promise<FunctionReturnType<Action>>
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `action` | `FunctionReference<'action'>` | The action to execute |
| `args` | `object` | Arguments for the action |
| `options.token` | `string` | Optional auth token |

### Example

```ts [server/api/email/send.post.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const body = await readBody(event)

  const result = await fetchAction(api.email.send, {
    to: body.to,
    subject: body.subject,
    template: body.template,
  })

  return result
})
```

## Use Cases

### API Routes

Expose Convex data through REST endpoints:

```ts [server/api/posts/index.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async () => {
  return fetchQuery(api.posts.list, {})
})
```

### Server Middleware

Check data before routing:

```ts [server/middleware/org-check.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const orgSlug = getRouterParam(event, 'org')
  if (!orgSlug) return

  const org = await fetchQuery(api.orgs.getBySlug, { slug: orgSlug })

  if (!org) {
    throw createError({ statusCode: 404, message: 'Organization not found' })
  }

  event.context.org = org
})
```

### Scheduled Tasks

With Nitro scheduled tasks:

```ts [server/tasks/cleanup.ts]
import { api } from '~~/convex/_generated/api'

export default defineTask({
  meta: {
    name: 'cleanup',
    description: 'Clean up expired sessions',
  },
  async run() {
    await fetchMutation(api.sessions.cleanup, {})
    return { result: 'Cleanup complete' }
  },
})
```

### Background Jobs

Process data server-side:

```ts [server/api/import.post.ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const body = await readBody(event)

  // Start processing
  for (const item of body.items) {
    await fetchMutation(api.items.import, { data: item })
  }

  return { imported: body.items.length }
})
```

## Error Handling

```ts [server/api/posts/[id].ts]
import { api } from '~~/convex/_generated/api'

export default defineEventHandler(async (event) => {
  const id = getRouterParam(event, 'id')

  try {
    const post = await fetchQuery(api.posts.get, { id })

    if (!post) {
      throw createError({ statusCode: 404 })
    }

    return post
  } catch (error) {
    if (error.message.includes('Unauthorized')) {
      throw createError({ statusCode: 401 })
    }
    throw error
  }
})
```

## TypeScript

Fully typed based on your Convex functions:

```ts
// If api.posts.get has args { id: Id<'posts'> }
// and returns Post | null

const post = await fetchQuery(api.posts.get, { id: '123' })
// post is Post | null

const postId = await fetchMutation(api.posts.create, {
  title: 'Hello',
  content: 'World',
})
// postId is Id<'posts'>
```

## Notes

- These utilities use HTTP, not WebSocket
- No real-time subscriptions in server context
- Token is optional but required for authenticated operations
- Errors from Convex are thrown as-is
